<body>
  <div id="root">
    <input id="readwrite"/>
    <div id="result"></div>
  </div>
</body>

<script>
  var rootEl = document.getElementById('root')
  var readWriteEl = document.getElementById('readwrite')
  var resultEl = document.getElementById('result')

  var isComposing = false
  var previousComposition = ""

  var fakeClipboard = ""

  var isExpectingCopyCut = false
  var isExpectingPaste = false

  rootEl.addEventListener('copy', function(e) {
    console.warn('copy')
    if (readWriteEl.selectionStart === readWriteEl.selectionEnd) {
      console.warn('quitting copy early to mimic browsers that require a non empty selection to copy')
      return
    }
    fakeClipboard = resultEl.innerHTML
    e.preventDefault()
  });

  rootEl.addEventListener('cut', function(e) {
    console.warn('cut')
    if (readWriteEl.selectionStart === readWriteEl.selectionEnd) {
      console.warn('quitting copy early to mimic browsers that require a non empty selection to copy')
      return
    }
    fakeClipboard = resultEl.innerHTML
    resultEl.innerHTML = ""
    e.preventDefault()
  });

  rootEl.addEventListener('paste', function(e) {
    console.warn('paste')
    resultEl.innerHTML += fakeClipboard
    e.preventDefault()
  });

  function updateFocus() {
    console.warn('updating focus')
    if (document.activeElement !== readWriteEl) {
      readWriteEl.focus()
    }

    if (isExpectingCopyCut) {
      readWriteEl.value = " "
      readWriteEl.selectionStart = 0
      readWriteEl.selectionEnd = 1
    } else {
      console.warn('clearing')
      readWriteEl.focus()
      readWriteEl.value = ""
    }
  }

  function setExpectingCopyCut(val) {
    if (isExpectingCopyCut === val) {
      return
    }
    isExpectingCopyCut = val
    updateFocus()
  }

  function setExpectingPaste(val) {
    if (isExpectingPaste === val) {
      return
    }
    isExpectingPaste = val
    updateFocus()
  }

  function keyDownCallback(e) {
    if (e.ctrlKey != 0 || e.metaKey != 0) {
      if (e.which === 'X'.charCodeAt() || e.which === 'C'.charCodeAt()) {
        setExpectingCopyCut(true)
      } else {
        setExpectingPaste(true)
      }
    }
  }
  readWriteEl.addEventListener('keydown', keyDownCallback)
  // readOnlyEl.addEventListener('keydown', keyDownCallback)

  function keyUpCallback(e) {
    setExpectingCopyCut(false)
    setExpectingPaste(false)
  }

  readWriteEl.addEventListener('keyup', keyUpCallback)
  // readOnlyEl.addEventListener('keyup', keyUpCallback)

  readWriteEl.addEventListener('compositionstart', function (e) {
    console.warn('compositionstart clearing element.value and composition')
    isComposing = true
    previousComposition = ""
    readWriteEl.value = ""
  })

  readWriteEl.addEventListener('compositionend', function (e) {
    console.warn('compositionend done composing')
    isComposing = false
  })
  
  readWriteEl.addEventListener('input', function (e) {
    console.warn('input', 'element.value', readWriteEl.value, 'previous', previousComposition)

    if (previousComposition.length) {
      resultEl.innerHTML = resultEl.innerHTML
        .slice(0, resultEl.innerHTML.length - previousComposition.length)
    }
    resultEl.innerHTML += readWriteEl.value
    
    if (isComposing) {
      previousComposition = readWriteEl.value
      console.warn('input', 'is composing, so new previous composition is', readWriteEl.value)
    } else {
      previousComposition = ""
      readWriteEl.value = ""
      console.warn('was not composing, so clearing')
    }
    
    e.preventDefault()
  })

  readWriteEl.addEventListener('focus', function (e) {
    isComposing = false
    previousComposition = ""
  })
</script>