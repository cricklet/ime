<body>
  <div id="root">
    <input id="readonly" readonly/>
    <input id="readwrite"/>
    <div id="result"></div>
  </div>
</body>

<script>
  var rootEl = document.getElementById('root')
  var readWriteEl = document.getElementById('readwrite')
  var readOnlyEl = document.getElementById('readonly')
  var resultEl = document.getElementById('result')

  var isComposing = false
  var previousComposition = ""

  var fakeClipboard = ""

  var isExpectingCopyCut = false
  var isExpectingPaste = false

  function activeInput() {
    return readWriteEl === document.activeElement ? readWriteEl : readOnlyEl
  }

  rootEl.addEventListener('copy', function(e) {
    console.warn('copy')
    if (activeInput().selectionStart === activeInput().selectionEnd) {
      console.warn('quitting copy early to mimic browsers that require a non empty selection to copy')
      return
    }
    fakeClipboard = resultEl.innerHTML
    e.preventDefault()
  });

  rootEl.addEventListener('cut', function(e) {
    console.warn('cut')
    if (activeInput().selectionStart === activeInput().selectionEnd) {
      console.warn('quitting copy early to mimic browsers that require a non empty selection to copy')
      return
    }
    fakeClipboard = resultEl.innerHTML
    resultEl.innerHTML = ""
    e.preventDefault()
  });

  rootEl.addEventListener('paste', function(e) {
    console.warn('paste')
    resultEl.innerHTML += fakeClipboard
    e.preventDefault()
  });

  function updateFocus() {
    if (document.isExpectingCopyCut) {
      if (document.activeElement !== readOnlyEl) {
        readOnlyEl.focus()
      }
      readOnlyEl.value = " "
      readOnlyEl.selectionStart = 0
      readOnlyEl.selectionEnd = 1
    } else {
      if (document.activeElement !== readWriteEl) {
        readWriteEl.focus()
      }
      readWriteEl.focus()
      readWriteEl.value = ""
    }
  }

  function setExpectingCopyCut(val) {
    if (isExpectingCopyCut === val) {
      return
    }
    isExpectingCopyCut = true
    updateFocus()
  }

  function setExpectingPaste(val) {
    if (isExpectingPaste === val) {
      return
    }
    isExpectingPaste = true
    updateFocus()
  }

  function keyDownCallback(e) {
    if (e.ctrlKey != 0 || e.metaKey != 0) {
      if (e.which === 'X'.charCodeAt() || e.which === 'C'.charCodeAt()) {
        setExpectingCopyCut(true)
      } else {
        setExpectingPaste(true)
      }
    }
  }
  readWriteEl.addEventListener('keydown', keyDownCallback)
  readOnlyEl.addEventListener('keydown', keyDownCallback)

  function keyUpCallback(e) {
    setExpectingCopyCut(false)
    setExpectingPaste(false)
  }

  readWriteEl.addEventListener('keyup', keyUpCallback)
  readOnlyEl.addEventListener('keyup', keyUpCallback)

  readWriteEl.addEventListener('compositionstart', function (e) {
    console.warn('compositionstart clearing element.value and composition')
    isComposing = true
    previousComposition = ""
    readWriteEl.value = ""
  })

  readWriteEl.addEventListener('compositionend', function (e) {
    console.warn('compositionend done composing')
    isComposing = false
  })
  
  readWriteEl.addEventListener('input', function (e) {
    console.warn('input', 'element.value', readWriteEl, readWriteEl.value)

    console.warn('input', 'previous composition', previousComposition, previousComposition.length)
    if (previousComposition.length) {
      resultEl.innerHTML = resultEl.innerHTML
        .slice(0, resultEl.innerHTML.length - previousComposition.length)
    }
    resultEl.innerHTML += readWriteEl.value
    
    if (isComposing) {
      previousComposition = readWriteEl.value
      console.warn('input', 'is composing, so previous composition is', readWriteEl, readWriteEl.value)
    } else {
      previousComposition = ""
      readWriteEl.value = ""
      console.warn('was not composing, so clearing')
    }
    
    e.preventDefault()
  })
</script>