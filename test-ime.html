<body>
  <div id="root">
    <input id="readwrite" placeholder="text" />
    <input id="readonly" placeholder="copy" readonly />
    <div id="result"></div>
  </div>
</body>

<script>
  var rootEl = document.getElementById('root')
  var resultEl = document.getElementById('result')

  var readWriteEl = document.getElementById('readwrite')
  var readOnlyEl = document.getElementById('readonly')

  var isComposing = false
  var previousComposition = ""

  var fakeClipboard = ""

  var isExpectingCopyCut = false
  var isExpectingPaste = false

  rootEl.addEventListener('copy', function(e) {
    console.warn('copy')
    if (readOnlyEl.selectionStart === readOnlyEl.selectionEnd) {
      console.warn('quitting copy early to mimic browsers that require a non empty selection to copy')
      return
    }
    fakeClipboard = resultEl.innerHTML
    e.preventDefault()
  });

  rootEl.addEventListener('cut', function(e) {
    console.warn('cut')
    if (readOnlyEl.selectionStart === readOnlyEl.selectionEnd) {
      console.warn('quitting copy early to mimic browsers that require a non empty selection to copy')
      return
    }
    fakeClipboard = resultEl.innerHTML
    resultEl.innerHTML = ""
    e.preventDefault()
  });

  rootEl.addEventListener('paste', function(e) {
    console.warn('paste')
    resultEl.innerHTML += fakeClipboard
    e.preventDefault()
  });

  function updateFocus() {
    console.warn('updating focus')

    if (isExpectingCopyCut) {
      if (document.activeElement !== readOnlyEl) {
        readOnlyEl.focus()
        readOnlyEl.value = " "
        readOnlyEl.selectionStart = 0
        readOnlyEl.selectionEnd = 1
      }
    } else {
      if (document.activeElement !== readWriteEl) {
        readWriteEl.focus()
      }
    }
  }

  function setExpectingCopyCut(val) {
    if (isExpectingCopyCut === val) {
      return
    }
    isExpectingCopyCut = val
    updateFocus()
  }

  function setExpectingPaste(val) {
    if (isExpectingPaste === val) {
      return
    }
    isExpectingPaste = val
    updateFocus()
  }

  readWriteEl.addEventListener('keydown', function(e) {
    if (e.ctrlKey != 0 || e.metaKey != 0) {
      if (e.which === 'X'.charCodeAt() || e.which === 'C'.charCodeAt()) {
        setExpectingCopyCut(true)
      } else {
        setExpectingPaste(true)
      }
    }
  })

  function keyUpCallback(e) {
    setExpectingCopyCut(false)
    setExpectingPaste(false)
  }
  readWriteEl.addEventListener('keyup', keyUpCallback)
  readOnlyEl.addEventListener('keyup', keyUpCallback)

  readWriteEl.addEventListener('compositionstart', function (e) {
    console.warn('compositionstart')
    isComposing = true
    previousComposition = ""
    readWriteEl.value = ""
  })

  readWriteEl.addEventListener('compositionend', function (e) {
    console.warn('compositionend')
    isComposing = false
  })
  
  readWriteEl.addEventListener('input', function (e) {
    console.warn(`received value "${readWriteEl.value}", previous composition "${previousComposition}"`)

    if (previousComposition.length) {
      resultEl.innerHTML = resultEl.innerHTML
        .slice(0, resultEl.innerHTML.length - previousComposition.length)
    }
    resultEl.innerHTML += readWriteEl.value
    
    if (isComposing) {
      previousComposition = readWriteEl.value
      console.warn('is composing, so new previous composition is', readWriteEl.value)
    } else {
      previousComposition = ""
      readWriteEl.value = ""
      console.warn('was not composing, so clearing value & previous')
    }
    
    e.preventDefault()
  })

  readWriteEl.addEventListener('focus', function (e) {
    isComposing = false
    previousComposition = ""
  })
</script>